<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<meta name="_csrf" th:content="${_csrf.token}">
<meta name="_csrf_header" th:content="${_csrf.headerName}">
<title>product main list</title>
<script>
	const successMessgae = '[[${ message }]]';
	
	if(successMessgae){
		alert(successMessgae);
	}
</script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
<link href="/css/common/common.css" rel="stylesheet">
<style>
	#header_area {
		display: flex;
		justify-content: space-between;
	}
	
	#top_area {
		display: flex;
		justify-content: space-between;
	}
	
	#open_regist_btn {
		background: #83131E;
		color: white;
		width: 100px;
		height: 40px;
		border-radius: 5px;
		margin-top: auto;
		margin-bottom: auto;
		border: 0;
	}
	
	h1 {
		display: inline;
	}
	
	#table_area {
		border: 1px solid #f9f9f9;
		width: 80%;
		margin-top: 20px;
		margin-left: auto;
		margin-right: auto;
	}
	
	#table_area th {
		background: rgba(196, 196, 196, 0.3);
	}
	
	#deleteMulti_btn {
		background: white;
		border-radius: 5px;
		color: #525252;
		border: 1px solid #525252;
	}
	
	td {
		border-right: 1px solid rgba(196, 196, 196, 0.3);
	}
	
	.center {
		text-align: center
	}
	.choose:hover{
		background:  rgba(196, 196, 196, 0.1);
		cursor : pointer;
	}
	#deleteMulti_btn {
		margin-left: 5px;
	}
	#hash_btn {
		background: #83131E;
		color: white;
		margin-left: 5px;
		border-radius: 5px;
		border: 1px solid #83131E;
	}
</style>
</head>
<body>
	<header th:include="common/header :: header"></header>
	<div id="header_area">
        <h1>상품관리</h1>
        <button id="open_regist_btn" onclick="location.href='/product/regist'">상품 등록</button>
    </div>
    <hr>
	<div id="top_area">
		<div>
			<button id="deleteMulti_btn">선택 삭제</button>
			<button id="hash_btn" onclick="openHashForm()">해시태그 관리</button>
		</div>
		<div>
			<select name="search_select">
				<option value="no">상품번호</option>
				<option value="name">상품명</option>
			</select> 
			<input type="text" name="search_product">
			<button id="search_btn">검색</button>
		</div>
	</div>
	<div>
		<form id="deleteMultiForm" th:action="@{/product/deleteMulti}" method="post" onsubmit="return checkConfirm()">
			<table id="table_area">
				<thead>
					<tr>
						<th><input type="checkbox" id="delete_all" name="delete_all"></th>
						<th>상품번호</th>
						<th>상품명</th>
						<th>판매가</th>
						<th>총 수량</th>
						<th>등록일</th>
						<th>수정일</th>
					</tr>
				</thead>
				<tbody id="productList">
					<tr th:each="product : ${ productList }">
						<td class="center"><input type="checkbox" name="delete_nums" th:value="${ product.productNo }"></td>
						<td class="center" th:text="${ product.productNo }"></td>
						<td class="choose" th:text="${ product.productKName }" th:onclick="|location.href='@{/product/detail/{productNo}(productNo=${product.productNo})}'|"></td>
						<td class="center" th:text="${ product.salePrice }"></td>
						<td class="center" th:text="${ product.productCount }"></td>
						<td class="center" th:text="${#dates.format(product.createDate, 'yyyy-MM-dd')}"></td>
						<td class="center" th:text="${#dates.format(product.modifyDate, 'yyyy-MM-dd')}"></td>
					</tr>
				</tbody>
			</table>
		</form> 
	</div>

	<footer th:include="common/footer :: footer"></footer>
	
	<script>

		var token = $("meta[name='_csrf']").attr("content");
		var header = $("meta[name='_csrf_header']").attr("content");
		$(document).ajaxSend(function(e, xhr, options) {
			xhr.setRequestHeader(header, token);
		});

		// 선택 삭제 버튼 클릭 시 deleteMultiForm submit
		$("#deleteMulti_btn").on("click", function() {
			$("#deleteMultiForm").submit();
		})

		// 삭제 확인 confirm 출력
		function checkConfirm() {
			if (confirm("정말 삭제하시겠습니까?"))
				return true
			else
				return false;
		}

		// 체크박스 전체 선택, 전체 해제
		$("#delete_all").click(function() {
			if ($("#delete_all").is(":checked"))
				$("input[name=delete_nums]").prop("checked", true);
			else
				$("input[name=delete_nums]").prop("checked", false);
		});

		$("input[name=delete_nums]").click(function() {
			var total = $("input[name=delete_nums]").length;
			var checked = $("input[name=delete_nums]:checked").length;

			if (total != checked)
				$("#delete_all").prop("checked", false);
			else
				$("#delete_all").prop("checked", true);
		});

		function dateFormat(date) {
			let month = date.getMonth() + 1;
			let day = date.getDate();

			month = month >= 10 ? month : '0' + month;
			day = day >= 10 ? day : '0' + day;

			return date.getFullYear() + '-' + month + '-' + day;
		}

		// 상품 검색
		$("#search_btn").on("click", function() {
			var searchStandard = $("select[name=search_select]").val();
			var searchValue = $("input[name=search_product]").val();

			var tableHTML;
			$.ajax({
				url : "/product/search",
				data : {searchStandard : searchStandard, searchValue : searchValue},
				type : "post",
				success : function(data) {
					if (data.length == 0) {
						alert("검색 결과가 없습니다.");
					} else {
						$.each(data, function(index, item) {

						let createDate = new Date(item.createDate);
						let modifyDate = new Date(item.modifyDate);

						tableHTML += "<tr><td class='center'><input type='checkbox' name='delete_nums' value='" + item.productNo + "'></td>"
									+ "<td class='center'>"+ item.productNo+ "</td>"
									+ "<td class=\"choose\" onclick=\"location.href='/product/detail/" + item.productNo + "'\">"+ item.productKName+ "</td>"
									+ "<td class='center'>"+ item.salePrice + "</td>"
									+ "<td class='center'>"+ item.productCount+ "</td>"
									+ "<td class='center'>"+ dateFormat(createDate)+ "</td>"
									+ "<td class='center'>"+ dateFormat(modifyDate)+ "</td></tr>"

									$("#productList").html(tableHTML);
						});
					}
				},
				error : function(e) {
					console.log(e);
				}						
			});
		});
		
		// 해시태그 관리 팝업
        function openHashForm(){
            window.open("/hashtag/form", "popup", "width=800, height=600");
        }
		
	</script>
	
	
</body>
</html>